# Definition for CI within GitLab
# Note:
#    Prefix any job name with a '.' to disable.
#


# Enable submodules
variables:
  GIT_STRATEGY: clone
  GIT_SUBMODULE_STRATEGY: none


# Common definitions for the jobs
.common: &common
  before_script:
    - git submodule sync ci
    - git submodule update --init ci
  artifacts: &artifacts
    when: always
    paths:
      - artifacts
      - test-output
      - ci-logs
  dependencies: []


.common-cross: &common-cross
  <<: *common
  artifacts:
    <<: *artifacts
#    reports:
#      junit:
#        - artifacts/results.xml


#### Test examples
test-examples:
  <<: *common-cross
  stage: test
  script:
    # Build the examples first, as if it fails we'll then not upload the results.
    - crosscompile/build-examples.sh
  tags:
    - linux


#### Exports ####
export-linux:
  <<: *common-cross
  stage: export-cross
  script:
    # Build and upload the binary to Artifactory.
    - if [ "$CI_COMMIT_BRANCH" = 'master' ] ; then upload=--upload ; else upload= ; fi
    - ci/build.sh native install ${upload}
  tags:
    - linux

export-macos:
  <<: *common-cross
  stage: export-cross
  script:
    - if [ "$CI_COMMIT_BRANCH" = 'master' ] ; then upload=--upload ; else upload= ; fi
    - ci/build.sh native install ${upload}
  tags:
    - macos


.build-command-riscos:
  <<: *common
  stage: build-riscos
  script:
    - ci/build.sh install


#### Stages to execute ####
stages:
# - build
  - test
  - export-cross
#  - build-riscos
